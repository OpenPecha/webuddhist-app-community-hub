on:
  issues:
    types: [opened]

jobs:
  add_metadata_and_format:
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to project and set status
        uses: actions/add-to-project@v1.0.1
        with:
          project-url: https://github.com/orgs/OpenPecha/projects/116
          github-token: ${{ secrets.PROJECT_MANAGEMENT_TOKEN }}

      - name: Format Userback Issue Body
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_MANAGEMENT_TOKEN }}
          script: |
            // 1. Fetch the current issue data
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // 2. Function to clean Userback HTML/Markdown mix
            function cleanUserbackBody(body) {
              if (!body) return "";
              
              let cleaned = body
                // Replace HTML break tags with newlines to fix spacing
                .replace(/<br\s*\/?>/gi, '\n')
                // Decode common HTML entities found in Userback data
                .replace(/&quot;/g, '"')
                .replace(/&#039;/g, "'")
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>');
                
              return cleaned;
            }

            // 3. Update issue if content exists and changes are needed
            if (issue.body) {
              const newBody = cleanUserbackBody(issue.body);
              
              // Only make an API call if formatting actually changed something
              if (newBody !== issue.body) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: newBody
                });
                console.log("Issue body formatted to Markdown.");
              }
            }
